# Subsocial squid

#### Indexer for work with both Subsocial and Soonsocial chains.

## Quick running

```bash
# 1. Update Squid SDK and install dependencies
npm run update
npm ci
# 2. Compile typescript files
make build
# 3. Start target Postgres database and detach
make up

# 4. Set env variable for specifying target blockchain
export CHAIN=subsocial # if you need rung indexer for subsocial network
# or
export CHAIN=soonsocial # if you need rung indexer for soonsocial network

# 5. Start the processor
make process
# 6. The command above will block the terminal
#    being busy with fetching the chain data,
#    transforming and storing it in the target database.
#
#    To start the graphql server open the separate terminal
#    and run
make serve
```

### Defined events in squid

```graphql
  PostCreated
  PostDeleted # synthetic
  PostUpdated
  PostShared # synthetic
  PostMoved
  PostFollowed # synthetic
  PostUnfollowed # synthetic
  PostReactionCreated
  PostReactionUpdated
  PostReactionDeleted

  SpaceCreated
  SpaceUpdated
  SpaceFollowed
  SpaceUnfollowed
  SpaceOwnershipTransferAccepted

  AccountFollowed
  AccountUnfollowed
  ProfileUpdated

  CommentCreated # synthetic
  CommentDeleted # synthetic
  CommentUpdated # synthetic
  CommentShared # synthetic
  CommentReactionCreated # synthetic
  CommentReactionUpdated # synthetic
  CommentReactionDeleted # synthetic
  CommentReplyCreated # synthetic
  CommentReplyDeleted # synthetic
  CommentReplyUpdated # synthetic
  CommentReplyShared # synthetic
  CommentReplyReactionCreated # synthetic
  CommentReplyReactionUpdated # synthetic
  CommentReplyReactionDeleted # synthetic
```

### Short info about indexer multi-chain structure

1. Chain configs/endpoints can be configured in `config.ts` file in appropriate folder of necessary chain:
   - Subsocial - `src/chains/subsocial/config.ts`
   - Soonsocial - `src/chains/soonsocial/config.ts`
2. Necessary events/calls/storage calls can be configured for each chain in appropriate file in `/typegen` folder.
3. Command `make typegen` uses custom [shel script](./scripts/typegen.sh) which generates types for each chain defined in `/typegen` folder.
4. Chain sensitive logic is implemented in sub-folder with appropriate name in `/src/chains` folder.
   It's required because each chain has it's own bunch of specs and as result it's own autogenerated types.
   Chain sensitive logic:
   - parsing events data
   - parsing calls data
   - making storage calls
5. Indexer can be deployed to Aquarium to 2 different squids with 2 separate deployment manifests:
   - Subsocial - [./squid-subsocial.yaml](./squid-subsocial.yaml)
   - Soonsocial - [./squid-soonsocial.yaml](./squid-soonsocial.yaml)

## Search API

Indexer GraphQL API has search query (`searchQuery`) with various parameters for filtering and full text search.

### Search query arguments:

- `indexes?: <string>` [ _default:_ `all` ] - _search within all or specific index (`all | spaces | posts`)_
- `limit?: <number>` [ _default:_ `10` ] - _number of search hits per page._
- `offset?: <number | null>` [ _default:_ `0` ] - _offset of search hits._
- `q?: <string>` [ _default:_ `*` ] - _search query._
- `spaceId?: <string>` - _filter search hits by provided `spaceId`._
- `tags?: <string[]>` - _filter search hits by provided tags._

All arguments listed above can be used together in any combination, except `spaceId + indexes:spaces`.

### Search query results:

- `err` - _search error if occurred. Can be `null` is not occurred._

  - `reason: <string>` - _text message of occurred error._
  - `status: <number>` - _error status code._

- `hits` - _search results items list_.
  - `_content` - _document source._
    - `name: <string>` - _value of field `name` (actual only for Space entity)._
    - `about: <string>` - _value of field `about` (actual only for Space entity)._
    - `username: <string>` - _value of field `username` (actual only for Space entity)._
    - `title: <string>` - _value of field `title` (actual only for Post entity)._
    - `body: <string>` - _value of field `body` (actual only for Post entity)._
    - `spaceId: <string>` - _value of field `spaceId` (actual only for Post entity)._
    - `tags: <string[]>` - _list of tags._
  - `_id: <string>` - _document ID (equal to on-chain entity ID)._
  - `_index: <string>` - _index particular document is located in._
  - `_score: <number>` - _search score of particular document._
- `total` - _total metadata for particular search request._
  - `limit: <string>` - _number of search hits per page, which has been used for this particular request._
  - `maxScore: <string>` - _maximum score within results scope of this particular search request._
  - `offset: <string>` - _page offset, which has been used for this particular request._
  - `totalResults: <string>` - _total number of hits matched to this particular request._

More detailed information about search API schema structure you can find in appropriate [model file](./src/server-extension/models/elasticSearchQuery.model.ts).
