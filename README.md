# Subsocial squid

#### Indexer for work with both Subsocial and Soonsocial chains.

## Quick running

```bash
# 1. Update Squid SDK and install dependencies
npm run update
npm ci
# 2. Compile typescript files
make build
# 3. Start target Postgres database and detach
make up

# 4. Set env variable for specifying target blockchain
export CHAIN=subsocial # if you need rung indexer for subsocial network
# or
export CHAIN=soonsocial # if you need rung indexer for soonsocial network

# 5. Start the processor
make process
# 6. The command above will block the terminal
#    being busy with fetching the chain data,
#    transforming and storing it in the target database.
#
#    To start the graphql server open the separate terminal
#    and run
make serve
```

### Defined events in squid

```graphql
  PostCreated
  PostDeleted # synthetic
  PostUpdated
  PostShared # synthetic
  PostMoved
  PostFollowed # synthetic
  PostUnfollowed # synthetic
  PostReactionCreated
  PostReactionUpdated
  PostReactionDeleted

  SpaceCreated
  SpaceUpdated
  SpaceFollowed
  SpaceUnfollowed
  SpaceOwnershipTransferAccepted

  AccountFollowed
  AccountUnfollowed
  ProfileUpdated

  CommentCreated # synthetic
  CommentDeleted # synthetic
  CommentUpdated # synthetic
  CommentShared # synthetic
  CommentReactionCreated # synthetic
  CommentReactionUpdated # synthetic
  CommentReactionDeleted # synthetic
  CommentReplyCreated # synthetic
  CommentReplyDeleted # synthetic
  CommentReplyUpdated # synthetic
  CommentReplyShared # synthetic
  CommentReplyReactionCreated # synthetic
  CommentReplyReactionUpdated # synthetic
  CommentReplyReactionDeleted # synthetic
```

### Short info about indexer multi-chain structure

1. Chain configs/endpoints can be configured in `config.ts` file in appropriate folder of necessary chain:
   - Subsocial - `src/chains/subsocial/config.ts`
   - Soonsocial - `src/chains/soonsocial/config.ts`
2. Necessary events/calls/storage calls can be configured for each chain in appropriate file in `/typegen` folder.
3. Command `make typegen` uses custom [shel script](./scripts/typegen.sh) which generates types for each chain defined in `/typegen` folder.
4. Chain sensitive logic is implemented in sub-folder with appropriate name in `/src/chains` folder.
   It's required because each chain has it's own bunch of specs and as result it's own autogenerated types.
   Chain sensitive logic:
   - parsing events data
   - parsing calls data
   - making storage calls
5. Indexer can be deployed to Aquarium to 2 different squids with 2 separate deployment manifests:
   - Subsocial - [./squid-subsocial.yaml](./squid-subsocial.yaml)
   - Soonsocial - [./squid-soonsocial.yaml](./squid-soonsocial.yaml)

## Search API

The Indexer GraphQL API has a search query (`searchQuery`) with various parameters for full text search and filtering.

### Search query arguments:

- `indexes?: <string>` [ _default:_ `all` ] - _search within all indices, or a specific index (`all | spaces | posts`)_
- `limit?: <number>` [ _default:_ `10` ] - _the number of search results per page._
- `offset?: <number | null>` [ _default:_ `0` ] - _the offset of the search results._
- `q?: <string>` [ _default:_ `*` ] - _the search query._
- `spaceId?: <string>` - _filter the search results by the provided `spaceId`._
- `tags?: <string[]>` - _filter the search results by the provided tags._

All arguments listed above can be used together in any combination, except for `spaceId + indexes:spaces`.

### Search query results:

- `err` - _the search result if an error occurred. It can be `null` if no error occurred._

  - `reason: <string>` - _the text message of the error._
  - `status: <number>` - _the status code of the error._

- `hits` - _The list of search results_.
  - `_content` - _the source of the document._
    - `name: <string>` - _the value of the `name` field (actual only for Space entity)._
    - `about: <string>` - _the value of the `about` field (actual only for Space entity)._
    - `username: <string>` - _the value of the `username` field (actual only for Space entity)._
    - `title: <string>` - _the value of the `title` field (actual only for Post entity)._
    - `body: <string>` - _the value of the `body` field (actual only for Post entity)._
    - `spaceId: <string>` - _the value of the `spaceId` field (actual only for Post entity)._
    - `tags: <string[]>` - _a list of the tags._
  - `_id: <string>` - _the document ID (equal to the on-chain entity's ID)._
  - `_index: <string>` - _index particular document is located in._
  - `_score: <number>` - _the search score of a particular document._
- `total` - _the total metadata for a particular search request._
  - `limit: <string>` - _number of search results per page that was used for this particular search request._
  - `maxScore: <string>` - _the maximum score within the scope of this particular search's results._
  - `offset: <string>` - _the page offset that was used for this particular search request._
  - `totalResults: <string>` - _the total number of results matched to this particular search request._

More detailed information about the search API's schema structure can be found in the appropriate [model file](./src/server-extension/models/elasticSearchQuery.model.ts).
